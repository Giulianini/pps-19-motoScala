language: bash
git:
  depth: false
os: linux
dist: xenial
env:
  - JDK="bellsoft-jdk8u265+1-linux-amd64-full"
stages:
  - check
  - telegram
jobs:
  include:
    - stage: check
      name: "Gradle check on Linux OS and JDK8"
      os: linux
      before_script:
        - echo "Downloading jdk"
        - wget https://github.com/sormuras/bach/raw/master/install-jdk.sh
        - source ./install-jdk.sh --url https://download.bell-sw.com/java/8u265+1/bellsoft-jdk8u265+1-linux-amd64-full.tar.gz
        - java -version
      script:
        - ./gradlew check --scan --parallel
      after_script:
        - echo "Preparing for deploy"
        - mkdir -p report
        - cp --parent */build/reports build/reports report -R
      before_deploy:
        - ./gradlew build fatjar --scan --parallel
      deploy:
        - provider: releases
          api_key: $GITHUB_TOKEN
          file_glob: true
          file: "${HOME}/build/Unibo-PPS-1920/pps-19-motoScala/build/libs/pps-19-motoScala-*.jar"
          skip_cleanup: 'true'
          on:
            os: linux
            repo: Unibo-PPS-1920/pps-19-motoScala
            branch: release
            #tags: true
        - provider: pages
          github_token: $GITHUB_TOKEN
          edge: true
          skip_cleanup: 'true'
          local_dir: "${HOME}/build/Unibo-PPS-1920/pps-19-motoScala/report"
          on:
            os: linux
            repo: Unibo-PPS-1920/pps-19-motoScala
            branch: release
            #tags: true
      after_deploy: 'curl -X  POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage
        -d chat_id=$TELEGRAM_CHAT_ID -d "text= Commit: $TRAVIS_COMMIT_MESSAGE %0ATag: $TRAVIS_TAG
        %0ALink: https://github.com/Unibo-PPS-1920/pps-19-motoScala/releases/latest/download/"'
    - stage: telegram
      name: Telegram notification
      if: tag IS NOT present AND type != pull_request
      os: linux
      script:
        - 'curl -X  POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage -d chat_id=$TELEGRAM_CHAT_ID
      -d "text=$(dirname $TRAVIS_REPO_SLUG) pushed to $TRAVIS_BRANCH %0ACommit: $TRAVIS_COMMIT_MESSAGE%0ALink:
      https://github.com/Unibo-PPS-1920/pps-19-motoScala/commits/$TRAVIS_BRANCH"'


